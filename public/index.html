<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Messenger MVP</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f0f2f5; margin: 0; display: flex; justify-content: center; align-items: center; height: 100vh; }
        .container { background: white; width: 100%; max-width: 500px; height: 90vh; display: flex; flex-direction: column; shadow: 0 2px 10px rgba(0,0,0,0.1); border-radius: 8px; overflow: hidden; }
        .hidden { display: none !important; }
        
        /* Стили чата */
        #chat-box { flex-grow: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 10px; background: #e5ddd5; }
        .msg { padding: 8px 15px; border-radius: 18px; max-width: 80%; word-wrap: break-word; font-size: 15px; position: relative; }
        .msg.me { background: #dcf8c6; align-self: flex-end; border-bottom-right-radius: 2px; }
        .msg.other { background: white; align-self: flex-start; border-bottom-left-radius: 2px; }
        
        /* Стили интерфейса */
        .header { background: #075e54; color: white; padding: 15px; display: flex; justify-content: space-between; align-items: center; }
        .avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; background: #ccc; }
        .search-area, .input-area { padding: 10px; background: #f0f0f0; display: flex; gap: 5px; }
        input { padding: 10px; border: 1px solid #ddd; border-radius: 20px; flex-grow: 1; outline: none; }
        button { background: #128c7e; color: white; border: none; padding: 10px 15px; border-radius: 20px; cursor: pointer; }
        .user-item { display: flex; align-items: center; gap: 10px; padding: 10px; border-bottom: 1px solid #eee; cursor: pointer; }
        .user-item:hover { background: #f9f9f9; }
    </style>
</head>
<body>

<div class="container">
    <div id="auth-screen" style="padding: 20px;">
        <h2 id="auth-title">Вход в мессенджер</h2>
        <div id="login-fields">
            <input type="text" id="log-login" placeholder="Email или Телефон" style="width:90%; margin-bottom:10px;"><br>
            <input type="password" id="log-pass" placeholder="Пароль" style="width:90%; margin-bottom:10px;"><br>
            <button onclick="login()">Войти</button>
            <p>Нет аккаунта? <span style="color:blue; cursor:pointer;" onclick="toggleAuth(true)">Регистрация</span></p>
        </div>
        <div id="reg-fields" class="hidden">
            <input type="text" id="reg-name" placeholder="Имя" style="width:90%; margin-bottom:10px;"><br>
            <input type="text" id="reg-phone" placeholder="Телефон" style="width:90%; margin-bottom:10px;"><br>
            <input type="email" id="reg-email" placeholder="Email" style="width:90%; margin-bottom:10px;"><br>
            <input type="password" id="reg-pass" placeholder="Пароль" style="width:90%; margin-bottom:10px;"><br>
            <label>Аватар: <input type="file" id="reg-avatar"></label><br><br>
            <button onclick="register()">Создать аккаунт</button>
            <p>Уже есть аккаунт? <span style="color:blue; cursor:pointer;" onclick="toggleAuth(false)">Войти</span></p>
        </div>
    </div>

    <div id="main-screen" class="hidden" style="display: flex; flex-direction: column; height: 100%;">
        <div class="header">
            <div id="user-info" style="display:flex; align-items:center; gap:10px;"></div>
            <button onclick="location.reload()" style="background:#cc0000;">Выйти</button>
        </div>
<div id="friend-requests-section" class="hidden" style="background: #fff3cd; padding: 15px; border: 1px solid #ffeeba; border-radius: 8px; margin-bottom: 10px;">
    <strong style="display: block; margin-bottom: 10px; color: #856404;">Вам пришел запрос в друзья:</strong>
    <div id="requests-list"></div>
</div>
        <div class="search-area">
            <input type="text" id="search-input" placeholder="Поиск людей...">
            <button onclick="searchUsers()">Найти</button>
        </div>
        <div id="search-results" style="max-height: 150px; overflow-y: auto; background: white;"></div>

        <div id="chat-header" style="padding: 10px; background: #eee; font-weight: bold; text-align: center;">
            Выберите чат для начала общения
        </div>
        
        <div id="chat-box"></div>

        <div class="input-area">
            <input type="text" id="msg-input" placeholder="Введите сообщение...">
            <button onclick="sendMessage()">➤</button>
        </div>
    </div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
    const socket = io();
    let currentUser = null;
    let activeChatUserId = null;

    function toggleAuth(isReg) {
        document.getElementById('login-fields').classList.toggle('hidden', isReg);
        document.getElementById('reg-fields').classList.toggle('hidden', !isReg);
        document.getElementById('auth-title').innerText = isReg ? 'Регистрация' : 'Вход';
    }

    // --- ЛОГИКА АВТОРИЗАЦИИ ---
    async function login() {
        const login = document.getElementById('log-login').value;
        const password = document.getElementById('log-pass').value;
        const res = await fetch('/login', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ login, password })
        });
        const data = await res.json();
        if (data.success) enterApp(data.user); else alert(data.error);
    }

    async function register() {
        const formData = new FormData();
        formData.append('name', document.getElementById('reg-name').value);
        formData.append('phone', document.getElementById('reg-phone').value);
        formData.append('email', document.getElementById('reg-email').value);
        formData.append('password', document.getElementById('reg-pass').value);
        formData.append('avatar', document.getElementById('reg-avatar').files[0]);

        const res = await fetch('/register', { method: 'POST', body: formData });
        const data = await res.json();
        if (data.success) enterApp(data.user); else alert(data.error);
    }

    function enterApp(user) {
        currentUser = user;
        document.getElementById('auth-screen').classList.add('hidden');
        document.getElementById('main-screen').classList.remove('hidden');
        document.getElementById('user-info').innerHTML = `
            <img src="${user.avatar || ''}" class="avatar" onerror="this.src='https://ui-avatars.com/api/?name=${user.name}'">
            <span>${user.name}</span>
        `;
        socket.emit('login', user.id);
    }

    // --- ЛОГИКА ПОИСКА ---
async function searchUsers() {
    const q = document.getElementById('search-input').value;
    const res = await fetch(`/search?q=${q}`);
    const users = await res.json();
    const container = document.getElementById('search-results');
    container.innerHTML = '';
    
    users.forEach(u => {
        if (u.id == currentUser.id) return;
        const div = document.createElement('div');
        div.className = 'user-item';
        div.innerHTML = `
            <img src="${u.avatar || ''}" class="avatar" onerror="this.src='https://ui-avatars.com/api/?name=${u.name}'"> 
            <span style="flex-grow:1">${u.name}</span>
            <button onclick="sendFriendRequest(${u.id})">Добавить</button>
        `;
        // Убрали onclick со всего div, чтобы кнопка работала отдельно
        container.appendChild(div);
    });
}

// 1. Отправка запроса
async function sendFriendRequest(toId) {
    console.log("Отправка запроса пользователю:", toId);
    try {
        const res = await fetch('/friends/request', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ fromId: currentUser.id, toId: toId })
        });
        const data = await res.json();
        if (res.ok) {
            alert("Запрос в друзья отправлен!");
        } else {
            alert(data.error || "Ошибка при отправке запроса");
        }
    } catch (e) {
        console.error("Ошибка сети:", e);
    }
}

// 2. Проверка входящих заявок
async function checkFriendRequests() {
    if (!currentUser) return;
    
    try {
        const res = await fetch(`/friends/requests?userId=${currentUser.id}`);
        const requests = await res.json();
        console.log("Входящие заявки:", requests);

        const section = document.getElementById('friend-requests-section');
        const list = document.getElementById('requests-list');
        
        if (requests.length > 0) {
            section.classList.remove('hidden');
            list.innerHTML = '';
            requests.forEach(r => {
                const div = document.createElement('div');
                div.style = "display: flex; justify-content: space-between; align-items: center; padding: 5px; border-bottom: 1px solid #ddd;";
                div.innerHTML = `
                    <span><b>${r.name}</b> хочет в друзья</span>
                    <button onclick="acceptFriend(${r.requestId})">Принять</button>
                `;
                list.appendChild(div);
            });
        } else {
            section.classList.add('hidden');
        }
    } catch (e) {
        console.error("Ошибка при проверке заявок:", e);
    }
}

// 3. Принятие заявки
async function acceptFriend(requestId) {
    console.log("Принятие заявки №:", requestId);
    try {
        const res = await fetch('/friends/accept', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ requestId: requestId })
        });
        if (res.ok) {
            alert("Теперь вы друзья!");
            checkFriendRequests(); // Обновляем список сразу
        }
    } catch (e) {
        alert("Не удалось принять запрос");
    }
}

// 4. НЕ ЗАБУДЬ: Вызывай проверку при входе
function enterApp(user) {
    currentUser = user;
    document.getElementById('auth-screen').classList.add('hidden');
    document.getElementById('main-screen').classList.remove('hidden');
    
    // ... твой код отрисовки профиля ...
    
    socket.emit('login', user.id);
    
    // Сразу проверяем заявки при входе
    checkFriendRequests();
    // И проверяем их каждые 30 секунд
    setInterval(checkFriendRequests, 30000);
}

async function acceptFriend(requestId) {
    await fetch('/friends/accept', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ requestId })
    });
    checkFriendRequests(); // Обновить список
}
    // --- ЛОГИКА ЧАТА (ИСПРАВЛЕННАЯ) ---
    async function startChat(user) {
        activeChatUserId = user.id;
        document.getElementById('chat-header').innerText = `Чат с ${user.name}`;
        document.getElementById('search-results').innerHTML = ''; // Скрыть поиск после выбора
        
        const box = document.getElementById('chat-box');
        box.innerHTML = '<p style="text-align:center">Загрузка истории...</p>';

        try {
            // Запрашиваем историю
            const res = await fetch(`/messages?myId=${currentUser.id}&userId=${user.id}`);
            const messages = await res.json();
            
            box.innerHTML = ''; 
            messages.forEach(msg => {
                // ВАЖНО: Приводим всё к числам для сравнения
                const isMe = Number(msg.sender_id) === Number(currentUser.id);
                addMessageToChat(msg.text, isMe ? 'me' : 'other');
            });
        } catch (e) {
            console.error("Ошибка загрузки истории", e);
        }
    }

   function sendMessage() {
    const input = document.getElementById('msg-input');
    const text = input.value.trim();
    
    if (!text || !activeChatUserId) return;

    // 1. Добавляем на экран у себя ОДИН раз
    addMessageToChat(text, 'me');

    // 2. Отправляем на сервер
    socket.emit('send_message', {
        toUserId: activeChatUserId,
        fromUserId: currentUser.id,
        text: text
    });

    input.value = ''; // Очищаем поле
}

    // Слушаем входящие
    socket.on('receive_message', (data) => {
        console.log("Получено сообщение:", data);
        // Добавляем только если окно чата открыто именно с этим отправителем
        if (activeChatUserId && Number(activeChatUserId) === Number(data.from)) {
            addMessageToChat(data.text, 'other');
        } else {
            alert("Новое сообщение от другого пользователя!");
        }
    });

    function addMessageToChat(text, type) {
        const box = document.getElementById('chat-box');
        const div = document.createElement('div');
        div.className = `msg ${type}`;
        div.textContent = text;
        box.appendChild(div);
        box.scrollTop = box.scrollHeight;
    }

socket.on('receive_message', (data) => {
    console.log("Получено сообщение:", data);
    
    // Проверяем: открыт ли у нас сейчас чат именно с тем, кто прислал?
    // Используем == для сравнения строки и числа
    if (activeChatUserId && activeChatUserId == data.from) {
        addMessageToChat(data.text, 'other');
    } else {
        // Если чат с ним не открыт, просто уведомляем
        alert("Новое сообщение от пользователя!");
    }
});
    // Отправка по нажатию Enter
document.getElementById('msg-input').addEventListener('keypress', function (e) {
    if (e.key === 'Enter') {
        sendMessage();
    }
});
</script>

</body>
</html>




